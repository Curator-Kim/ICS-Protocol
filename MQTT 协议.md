# MQTT 协议

## MQTT 简介

MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议）

MQTT是一个基于客户端-服务器的消息发布/订阅传输协议。MQTT协议是轻量、简单、开放和易于实现的，这些特点使它适用范围非常广泛。在很多情况下，包括受限的环境中，如：机器与机器（M2M）通信和物联网（IoT）。其在，通过卫星链路通信传感器、偶尔拨号的医疗设备、智能家居、及一些小型化设备中已广泛使用。

## 主要特性

MQTT协议工作在低带宽、不可靠的网络的远程传感器和控制设备通讯而设计的协议，它具有以下主要的几项特性：

- （1）使用发布/订阅消息模式，提供一对多的消息发布，解除应用程序耦合。

  这一点很类似于XMPP，但是MQTT的信息冗余远小于XMPP，,因为XMPP使用XML格式文本来传递数据。

- （2）对负载内容屏蔽的消息传输。

- （3）使用TCP/IP提供网络连接。

  主流的MQTT是基于TCP连接进行数据推送的，但是同样有基于UDP的版本，叫做MQTT-SN。这两种版本由于基于不同的连接方式，优缺点自然也就各有不同了。

- （4）有三种消息发布服务质量：

  "至多一次"，消息发布完全依赖底层TCP/IP网络。会发生消息丢失或重复。这一级别可用于如下情况，环境传感器数据，丢失一次读记录无所谓，因为不久后还会有第二次发送。这一种方式主要普通APP的推送，倘若你的智能设备在消息推送时未联网，推送过去没收到，再次联网也就收不到了。

  "至少一次"，确保消息到达，但消息重复可能会发生。

  "只有一次"，确保消息到达一次。在一些要求比较严格的计费系统中，可以使用此级别。在计费系统中，消息重复或丢失会导致不正确的结果。这种最高质量的消息发布服务还可以用于即时通讯类的APP的推送，确保用户收到且只会收到一次。

- （5）小型传输，开销很小（固定长度的头部是2字节），协议交换最小化，以降低网络流量。

  这就是为什么在介绍里说它非常适合"在物联网领域，传感器与服务器的通信，信息的收集"，要知道嵌入式设备的运算能力和带宽都相对薄弱，使用这种协议来传递消息再适合不过了。

- （6）使用Last Will和Testament特性通知有关各方客户端异常中断的机制。

  Last Will：即遗言机制，用于通知同一主题下的其他设备发送遗言的设备已经断开了连接。

  Testament：遗嘱机制，功能类似于Last Will。

## MQTT协议原理

### MQTT协议实现方式

实现MQTT协议需要客户端和服务器端通讯完成，在通讯过程中，MQTT协议中有三种身份：发布者（Publish）、代理（Broker）（服务器）、订阅者（Subscribe）。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。

MQTT传输的消息分为：主题（Topic）和负载（payload）两部分：

- （1）Topic，可以理解为消息的类型，订阅者订阅（Subscribe）后，就会收到该主题的消息内容（payload）；
- （2）payload，可以理解为消息的内容，是指订阅者具体要使用的内容。

### 网络传输与应用消息

MQTT会构建底层网络传输：它将建立客户端到服务器的连接，提供两者之间的一个有序的、无损的、基于字节流的双向传输。

当应用数据通过MQTT网络发送时，MQTT会把与之相关的服务质量（QoS）和主题名（Topic）相关连。

### MQTT客户端

一个使用MQTT协议的应用程序或者设备，它总是建立到服务器的网络连接。客户端可以：

- （1）发布其他客户端可能会订阅的信息；
- （2）订阅其它客户端发布的消息；
- （3）退订或删除应用程序的消息；
- （4）断开与服务器连接。

### MQTT服务器

MQTT服务器以称为"消息代理"（Broker），可以是一个应用程序或一台设备。它是位于消息发布者和订阅者之间，它可以：

- （1）接受来自客户的网络连接；
- （2）接受客户发布的应用信息；
- （3）处理来自客户端的订阅和退订请求；
- （4）向订阅的客户转发应用程序消息。

### MQTT协议中的订阅、主题、会话

**一、订阅（Subscription）**

订阅包含主题筛选器（Topic Filter）和最大服务质量（QoS）。订阅会与一个会话（Session）关联。一个会话可以包含多个订阅。每一个会话中的每个订阅都有一个不同的主题筛选器。

**二、会话（Session）**

每个客户端与服务器建立连接后就是一个会话，客户端和服务器之间有状态交互。会话存在于一个网络之间，也可能在客户端和服务器之间跨越多个连续的网络连接。

**三、主题名（Topic Name）**

连接到一个应用程序消息的标签，该标签与服务器的订阅相匹配。服务器会将消息发送给订阅所匹配标签的每个客户端。

**四、主题筛选器（Topic Filter）**

一个对主题名通配符筛选器，在订阅表达式中使用，表示订阅所匹配到的多个主题。

**五、负载（Payload）**

消息订阅者所具体接收的内容。

### MQTT协议中的方法

MQTT协议中定义了一些方法（也被称为动作），来于表示对确定资源所进行操作。这个资源可以代表预先存在的数据或动态生成数据，这取决于服务器的实现。通常来说，资源指服务器上的文件或输出。主要方法有：

- （1）Connect。等待与服务器建立连接。
- （2）Disconnect。等待MQTT客户端完成所做的工作，并与服务器断开TCP/IP会话。
- （3）Subscribe。等待完成订阅。
- （4）UnSubscribe。等待服务器取消客户端的一个或多个topics订阅。
- （5）Publish。MQTT客户端发送消息请求，发送完成后返回应用程序线程。

## MQTT格式

在MQTT协议中，一个MQTT数据包由：固定头（Fixed header）、可变头（Variable header）、消息体（payload）三部分构成。MQTT数据包结构如下：

- （1）固定头（Fixed header）。存在于所有MQTT数据包中，表示数据包类型及数据包的分组类标识。
- （2）可变头（Variable header）。存在于部分MQTT数据包中，数据包类型决定了可变头是否存在及其具体内容。
- （3）消息体（Payload）。存在于部分MQTT数据包中，表示客户端收到的具体内容。

### 固定报头

| **Bit**   | **7**              | **6**                        | **5** | **4** | **3** | **2** | **1** | **0** |
| --------- | ------------------ | ---------------------------- | ----- | ----- | ----- | ----- | ----- | ----- |
| byte 1    | MQTT控制报文的类型 | 用于指定控制报文类型的标志位 |       |       |       |       |       |       |
| byte 2... | 剩余长度           |                              |       |       |       |       |       |       |

#### MQTT控制报文的类型 MQTT Control Packet type

**位置：**第1个字节，二进制位7-4。

表示为4位无符号值，这些值的定义见下表

**控制报文的类型**

| **名字**    | **值** | **报文流动方向** | **描述**                            |
| ----------- | ------ | ---------------- | ----------------------------------- |
| Reserved    | 0      | 禁止             | 保留                                |
| CONNECT     | 1      | 客户端到服务端   | 客户端请求连接服务端                |
| CONNACK     | 2      | 服务端到客户端   | 连接报文确认                        |
| PUBLISH     | 3      | 两个方向都允许   | 发布消息                            |
| PUBACK      | 4      | 两个方向都允许   | QoS 1消息发布收到确认               |
| PUBREC      | 5      | 两个方向都允许   | 发布收到（保证交付第一步）          |
| PUBREL      | 6      | 两个方向都允许   | 发布释放（保证交付第二步）          |
| PUBCOMP     | 7      | 两个方向都允许   | QoS 2消息发布完成（保证交互第三步） |
| SUBSCRIBE   | 8      | 客户端到服务端   | 客户端订阅请求                      |
| SUBACK      | 9      | 服务端到客户端   | 订阅请求报文确认                    |
| UNSUBSCRIBE | 10     | 客户端到服务端   | 客户端取消订阅请求                  |
| UNSUBACK    | 11     | 服务端到客户端   | 取消订阅报文确认                    |
| PINGREQ     | 12     | 客户端到服务端   | 心跳请求                            |
| PINGRESP    | 13     | 服务端到客户端   | 心跳响应                            |
| DISCONNECT  | 14     | 客户端到服务端   | 客户端断开连接                      |
| Reserved    | 15     | 禁止             | 保留                                |

#### 标志 Flags

固定报头第1个字节的剩余的4位 [3-0]包含每个MQTT控制报文类型特定的标志，见 [表格 2.2 -标志位](https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/02-ControlPacketFormat.html#表格-2.2--标志位)。表格 2.2中任何标记为“保留”的标志位，都是保留给以后使用的，**必须**设置为表格中列出的值 [MQTT-2.2.2-1]。如果收到非法的标志，接收者**必须**关闭网络连接。有关错误处理的详细信息见 4.8节 [MQTT-2.2.2-2]。

**表格 2.2 - 标志位 Flag Bits**

| **控制报文** | **固定报头标志**   | **Bit 3** | **Bit 2** | **Bit 1** | **Bit 0** |
| ------------ | ------------------ | --------- | --------- | --------- | --------- |
| CONNECT      | Reserved           | 0         | 0         | 0         | 0         |
| CONNACK      | Reserved           | 0         | 0         | 0         | 0         |
| PUBLISH      | Used in MQTT 3.1.1 | DUP1      | QoS2      | QoS2      | RETAIN3   |
| PUBACK       | Reserved           | 0         | 0         | 0         | 0         |
| PUBREC       | Reserved           | 0         | 0         | 0         | 0         |
| PUBREL       | Reserved           | 0         | 0         | 1         | 0         |
| PUBCOMP      | Reserved           | 0         | 0         | 0         | 0         |
| SUBSCRIBE    | Reserved           | 0         | 0         | 1         | 0         |
| SUBACK       | Reserved           | 0         | 0         | 0         | 0         |
| UNSUBSCRIBE  | Reserved           | 0         | 0         | 1         | 0         |
| UNSUBACK     | Reserved           | 0         | 0         | 0         | 0         |
| PINGREQ      | Reserved           | 0         | 0         | 0         | 0         |
| PINGRESP     | Reserved           | 0         | 0         | 0         | 0         |
| DISCONNECT   | Reserved           | 0         | 0         | 0         |           |

- DUP1 =控制报文的重复分发标志
- QoS2 = PUBLISH报文的服务质量等级
- RETAIN3 = PUBLISH报文的保留标志

#### 剩余长度 Remaining Length

**位置：**从第2个字节开始。

**位置：**从第2个字节开始。

剩余长度（Remaining Length）表示当前报文剩余部分的字节数，包括可变报头和负载的数据。剩余长度不包括用于编码剩余长度字段本身的字节数。

剩余长度字段使用一个变长度编码方案，对小于128的值它使用单字节编码。更大的值按下面的方式处理。低7位有效位用于编码数据，最高有效位用于指示是否有更多的字节。因此每个字节可以编码128个数值和一个*延续位（continuation bit）*。剩余长度字段最大4个字节。

> **非规范评注**
>
> 例如，十进制数64会被编码为一个字节，数值是64，十六进制表示为0x40,。十进制数字321(=65+2*128)被编码为两个字节，最低有效位在前。第一个字节是 65+128=193。注意最高位为1表示后面至少还有一个字节。第二个字节是2。
>
> **非规范评注**
>
> 这允许应用发送最大256MB(268,435,455)大小的控制报文。这个数值在报文中的表示是：0xFF,0xFF,0xFF,0x7F。
>
> [表格 2.4剩余长度字段的大小](https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/02-ControlPacketFormat.html#_Table_2.4_Size)展示了剩余长度字段所表示的值随字节增长。

**表格 2.4剩余长度字段的大小 Size of Remaining Length field**

| **字节数** | **最小值**                         | **最大值**                           |
| ---------- | ---------------------------------- | ------------------------------------ |
| 1          | 0 (0x00)                           | 127 (0x7F)                           |
| 2          | 128 (0x80, 0x01)                   | 16 383 (0xFF, 0x7F)                  |
| 3          | 16 384 (0x80, 0x80, 0x01)          | 2 097 151 (0xFF, 0xFF, 0x7F)         |
| 4          | 2 097 152 (0x80, 0x80, 0x80, 0x01) | 268 435 455 (0xFF, 0xFF, 0xFF, 0x7F) |

分别表示（每个字节的低7位用于编码数据，最高位是标志位）：

- 1个字节时，从0(0x00)到127(0x7f)
- 2个字节时，从128(0x80,0x01)到16383(0Xff,0x7f)
- 3个字节时，从16384(0x80,0x80,0x01)到2097151(0xFF,0xFF,0x7F)
- 4个字节时，从2097152(0x80,0x80,0x80,0x01)到268435455(0xFF,0xFF,0xFF,0x7F)

> 每个字节的有效数据位只有7位，最高位仅表示是否还有延续

### 可变报头 Variable header

某些MQTT控制报文包含一个可变报头部分。它在固定报头和负载之间。可变报头的内容根据报文类型的不同而不同。可变报头的报文标识符（Packet Identifier）字段存在于在多个类型的报文里。

#### 报文标识符 Packet Identifier

**图例 2.3 -报文标识符字节 Packet Identifier bytes**

| **Bit** | **7** - **0**  |
| ------- | -------------- |
| byte 1  | 报文标识符 MSB |
| byte 2  | 报文标识符 LSB |

很多控制报文的可变报头部分包含一个两字节的报文标识符字段。这些报文是PUBLISH（QoS > 0时）， PUBACK，PUBREC，PUBREL，PUBCOMP，SUBSCRIBE, SUBACK，UNSUBSCRIBE，UNSUBACK。

SUBSCRIBE，UNSUBSCRIBE和PUBLISH（QoS大于0）控制报文**必须**包含一个非零的16位报文标识符（Packet Identifier）[MQTT-2.3.1-1]。客户端每次发送一个新的这些类型的报文时都**必须**分配一个当前未使用的报文标识符 [MQTT-2.3.1-2]。如果一个客户端要重发这个特殊的控制报文，在随后重发那个报文时，它**必须**使用相同的标识符。当客户端处理完这个报文对应的确认后，这个报文标识符就释放可重用。QoS 1的PUBLISH对应的是PUBACK，QoS 2的PUBLISH对应的是PUBCOMP，与SUBSCRIBE或UNSUBSCRIBE对应的分别是SUBACK或UNSUBACK [MQTT-2.3.1-3]。发送一个QoS 0的PUBLISH报文时，相同的条件也适用于服务端 [MQTT-2.3.1-4]。

QoS等于0的PUBLISH报文**不能**包含报文标识符 [MQTT-2.3.1-5]。

PUBACK, PUBREC, PUBREL报文**必须**包含与最初发送的PUBLISH报文相同的报文标识符 [MQTT-2.3.1-6]。类似地，SUBACK和UNSUBACK**必须**包含在对应的SUBSCRIBE和UNSUBSCRIBE报文中使用的报文标识符 [MQTT-2.3.1-7]。

需要报文标识符的控制报文在 [表格 2.5 -包含报文标识符的控制报文](https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/02-ControlPacketFormat.html#_Table_2.5_-) 中列出。

**表格 2.5 -包含报文标识符的控制报文 Control Packets that contain a Packet Identifier**

| **控制报文** | **报文标识符字段**  |
| ------------ | ------------------- |
| CONNECT      | 不需要              |
| CONNACK      | 不需要              |
| PUBLISH      | 需要（如果QoS > 0） |
| PUBACK       | 需要                |
| PUBREC       | 需要                |
| PUBREL       | 需要                |
| PUBCOMP      | 需要                |
| SUBSCRIBE    | 需要                |
| SUBACK       | 需要                |
| UNSUBSCRIBE  | 需要                |
| UNSUBACK     | 需要                |
| PINGREQ      | 不需要              |
| PINGRESP     | 不需要              |
| DISCONNECT   | 不需要              |

客户端和服务端彼此独立地分配报文标识符。因此，客户端服务端组合使用相同的报文标识符可以实现并发的消息交换。

> **非规范评注**
>
> 客户端发送标识符为0x1234的PUBLISH报文，它有可能会在收到那个报文的PUBACK之前，先收到服务端发送的另一个不同的但是报文标识符也为0x1234的PUBLISH报文。

| Client    | Server                      |
| --------- | --------------------------- |
| PUBLISH   | Packet Identifier=0x1234--- |
| --PUBLISH | Packet Identifier=0x1234    |
| PUBACK    | Packet Identifier=0x1234--- |
| --PUBACK  | Packet Identifier=0x1234    |

### 有效载荷 Payload

某些MQTT控制报文在报文的最后部分包含一个有效载荷，这将在第三章论述。对于PUBLISH来说有效载荷就是应用消息。[表格 2.6 – 包含有效载荷的控制报文](https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/02-ControlPacketFormat.html#_Table_2.6_-) 列出了需要有效载荷的控制报文。

**表格 2.6 – 包含有效载荷的控制报文 Control Packets that contain a Payload**

| **控制报文** | **有效载荷** |
| ------------ | ------------ |
| CONNECT      | 需要         |
| CONNACK      | 不需要       |
| PUBLISH      | 可选         |
| PUBACK       | 不需要       |
| PUBREC       | 不需要       |
| PUBREL       | 不需要       |
| PUBCOMP      | 不需要       |
| SUBSCRIBE    | 需要         |
| SUBACK       | 需要         |
| UNSUBSCRIBE  | 需要         |
| UNSUBACK     | 不需要       |
| PINGREQ      | 不需要       |
| PINGRESP     | 不需要       |
| DISCONNECT   | 不需要       |



# 参考资料

1. [MQTT 入门介绍 | 菜鸟教程 (runoob.com)](https://www.runoob.com/w3cnote/mqtt-intro.html)
2. [第二章 – MQTT控制报文格式 · MQTT协议中文版 (gitbooks.io)](https://mcxiaoke.gitbooks.io/mqtt-cn/content/mqtt/02-ControlPacketFormat.html)