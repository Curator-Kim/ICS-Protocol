# LPD协议 笔记

LPD/LPR 全称 Line printer daemon protocol，默认使用TCP 515端口。

### 消息格式

打印机响应发送到其端口的命令。所有命令都以一个八位位组代码开头，该代码是一个二进制数，代表所请求的功能。  代码后面紧跟要执行功能的打印机队列的 ASCII 名称。  如果命令中还有其他操作数，则用空格（ASCII 空格、水平制表符、垂直制表符和换页符）将其与打印机队列名称隔开。 命令的结束用 ASCII 换行符表示。

### 图表规范

（用于说明接下来图表各字段的含义）

如果方框内是2个十进制的数字，则表示将要使用的8位二进制数

如果是两个大写字符，则表示将要使用的ASCII控制符（有一个例外，如果是SP，则代表空格。）

如果是单个字母，那么必须发送这个字母的ASCII的值，否则，该内容将作为字段内容的助记符，即一个八位位组序列。

### 命令

#### 打印任务

```
      +----+-------+----+
      | 01 | Queue | LF |
      +----+-------+----+
```

指令码：01

操作数 - 打印机队列名称

如果打印进程尚未运行，该命令将启动打印进程。

#### 接收任务

```
      +----+-------+----+
      | 02 | Queue | LF |
      +----+-------+----+
```

指令码：02

操作数：打印队列名称

接收作业是由第二级命令控制的。守护进程通过在同一连接上发送命令来获得命令。下一节将介绍这些命令。

发送该命令后，客户端必须从进程中读取一个确认八位位组。  正确认是一个零比特的八位位组。  负确认是一个包含任何其他模式的八位位组。

#### 发送队列状态（short）

```
      +----+-------+----+------+----+
      | 03 | Queue | SP | List | LF |
      +----+-------+----+------+----+
```

指令码：03

操作数1：打印队列名称

其他操作数：用户名或任务序号

如果提供了用户名或任务编号，或同时提供了用户名和任务编号，则只会发送这些用户的任务或带有这些编号的任务。

响应是描述打印机队列的 ASCII 数据流，该数据流一直持续到连接关闭为止。  行尾用 ASCII LF 控制字符表示。  行中还可能包含 ASCII HT 控制字符。

#### 发送队列状态（long）

```
      +----+-------+----+------+----+
      | 04 | Queue | SP | List | LF |
      +----+-------+----+------+----+
```

指令码：04

操作数1：打印队列名称

如果提供了用户名或任务编号，或同时提供了用户名和任务编号，则只发送这些用户的任务或带有这些编号的任务。 

响应是描述打印机队列的 ASCII 数据流。 该数据流一直持续到连接关闭为止。  行尾用 ASCII LF 控制字符表示。  行中还可能包含 ASCII HT 控制字符。

#### 移除任务

```
      +----+-------+----+-------+----+------+----+
      | 05 | Queue | SP | Agent | SP | List | LF |
      +----+-------+----+-------+----+------+----+
```

指令码：05

操作数1：打印队列名称

操作数2：发送请求的用户名（Agent）

其他操作数：用户名或任务号

该命令将删除指定队列中的打印任务，这些任务将作为其他操作数列出。  如果只给出Agent，该命令将删除当前活动作业。  除非Agent为 "root"，否则无法删除非用户所有的作业。  指定用户名而不是编号也是如此。  也就是说，代理 "root "可以通过用户名删除作业，而其他Agent则不行。

### 接收任务子指令

打印机收到接收任务命令（指令码02的任务）后，将处理这些命令。 进程将继续处理命令，直至连接关闭。

发送子命令后，客户端必须等待打印机进程的确认。 正确认是一个零比特的八位位组。负确认是任何其他模式的八位位组。

LPR 客户端应能以任一顺序发送接收数据文件和接收控制文件子命令。  LPR 服务器必须能够首先接收控制文件子命令，并且应该能够首先接收数据文件子命令。

#### 中断任务

```
      +----+----+
      | 01 | LF |
      +----+----+
```

指令码：01

不提供操作数，该子命令将删除在此 "接收任务 "命令期间创建的任何文件。

#### 接收控制文件

```
      +----+-------+----+------+----+
      | 02 | Count | SP | Name | LF |
      +----+-------+----+------+----+
```

指令码：2

操作数1：控制文件的字节数

操作数2：控制文件的名称

控制文件必须是 ASCII 码流，行尾用 ASCII 码 LF 表示。  数据流的总字节数作为第一个操作数发送。  控制文件的名称作为第二个操作数发送。  它应以 ASCII 码 "cfA "开头，然后是三位数的任务编号，接着是创建控制文件的主机名。  命令发送后，必须照常进行确认处理。

同一 TCP 连接上的下一个 "操作数 1 "字节是控制文件的预期内容。  一旦所有内容都已发送完毕，就会发送一个零比特的八位位组，表示发送的文件已完成。  此时必须进行第二级确认处理。

#### 接收数据文件

```
      +----+-------+----+------+----+
      | 03 | Count | SP | Name | LF |
      +----+-------+----+------+----+
```

指令码：3

操作数1：数据文件的字节数

操作数2：数据文件的名称

数据文件可包含任何 8 位数值。  数据流中的字节总数可以作为第一个操作数发送，否则该字段应清零为 0。  之后是三位数的任务编号。  工作编号后应跟有创建数据文件的主机名。  数据文件内容的解释取决于相应控制文件的内容。  如果指定了数据文件长度，则同一 TCP 连接上的下一个 "操作数 1 "字节就是数据文件的预期内容。  在这种情况下，一旦所有内容都已发送完毕，就会发送一个零比特的八进制数，表示发送的文件已完成。  此时必须进行第二级确认处理。

### 控制文件行

本节讨论发送给行式打印机守护进程的控制文件中各行的格式。

控制文件的每一行都由一个可打印的 ASCII 字符组成，代表打印文件时要执行的功能。  这些命令字符的解释区分大小写。  命令字符后一行的其余部分是命令的操作数。  命令字符后不允许有前导空白。  该行以 ASCII 新行结束。

以小写字母作为命令代码的命令用于指定实际打印请求。  使用大写字母的命令用于描述参数值或背景条件。

有些命令必须包含在每个控制文件中。  这些命令是 "H"（负责主机）和 "P"（负责用户）。  此外，必须至少有一条小写命令才能产生任何输出。

#### 横幅页面类

```
      +---+-------+----+
      | C | Class | LF |
      +---+-------+----+
```

指令码：'C'

操作数：横幅页面类名称

这条命令设置要打印在横幅页面上的类名。 类名必须是 31 个或更少的八位字节。  名称可以省略。  如果省略，将使用打印文件的主机名称。 该类通常用于显示打印任务所来自的主机。  除非同时使用打印横幅命令（'L'），否则该命令将被忽略。

#### 主机名称

```
      +---+------+----+
      | H | Host | LF |
      +---+------+----+
```

指令码：'H'

操作数：主机名称

该命令指定要作为打印任务源处理的主机名称。  该命令必须包含在控制文件中。  主机名必须为 31 或更少的八位字节。

#### 缩进印刷

```
      +---+-------+----+
      | I | count | LF |
      +---+-------+----+
```

指令码：‘I’

操作数：缩进数

 对于使用 "f "打印的文件，该命令指定所给列的列数。  (标识计数操作数必须全部为十进制数。

#### 横幅页面的工作名称

```
      +---+----------+----+
      | J | Job name | LF |
      +---+----------+----+
```

指令码：‘J'

操作数：任务名称

此命令设置要打印在横幅页面上的任务名称。  任务名称必须为 99 或更少的八位字节。  可以省略。  作业名称通常用于显示已 "打印 "文件的名称。  除非同时使用打印横幅命令（'L'），否则该名称将被忽略。

#### 打印时邮寄

```
      +---+------+----+
      | M | user | LF |
      +---+------+----+
```

指令码：’M'

操作数：用户名称

当打印操作结束（成功或失败）时，此条目会将邮件发送给在“H”条目指定的主机上指定为操作数的用户。

#### 源文件名称

```
      +---+------+----+
      | N | Name | LF |
      +---+------+----+
```

指令码：N

操作数：文件名

 该命令指定构建数据文件的文件名。  在没有给出标题时，它将在查询时返回，并与 "p "命令一起用于打印。  它必须是 131 个或更少的八位字节。

#### 用户标识

```
      +---+------+----+
      | P | Name | LF |
      +---+------+----+
```

指令码：P

操作数：用户id

该命令指定申请打印任务实体的用户标识。  该命令必须包含在控制文件中。  用户标识必须是 31 个或更少的八位字节。

#### 符号链接数据

```
      +---+--------+----+-------+----+
      | S | device | SP | inode | LF |
      +---+--------+----+-------+----+
```

指令码：S

操作数1：设备序号

操作数2：节点序号

该命令用于在 Unix 系统中记录符号链接数据，这样在打印文件后更改文件的目录条目就不会打印新文件。如果数据文件没有符号链接，该命令将被忽略。

#### Title for pr

```
      +---+-------+----+
      | T | title | LF |
      +---+-------+----+
```

指令码：T

操作数：标题

该命令为使用 "p "命令打印的文件提供标题（其他打印命令忽略该标题）。  (标题必须为 79 或更少的八位字节。

#### 解除数据文件的链接

```
      +---+------+----+
      | U | file | LF |
      +---+------+----+
```

指令码：U

操作数：要解除链接的文件

该命令表示不再需要的文件。 该命令只能用于数据文件。

#### 输出宽度

```
      +---+-------+----+
      | W | width | LF |
      +---+-------+----+
```

指令码：W

操作数：宽度

对于 "f"、"l "和 "p "命令，该命令将输出限制为指定的列数（对于其他输出生成命令，该命令将被忽略）。  (宽度计数操作数必须全部为十进制数。  它可以被静默地减小到某个更小的数值。  宽度的默认值为 132。

#### troff R font

```
      +---+------+----+
      | 1 | file | LF |
      +---+------+----+
```

指令码：1

操作数：文件名

该命令用于指定 troff R 字体的文件名。  [1] 这是默认使用 Times Roman 打印的字体。

#### troff I font

```
      +---+------+----+
      | 2 | file | LF |
      +---+------+----+
```

指令码：2

操作数：文件名

该命令用于指定 troff I 字体的文件名。  [1] 这是默认使用 Times Italic 打印的字体。

#### troff B font

```
      +---+------+----+
      | 3 | file | LF |
      +---+------+----+
```

指令码：3

操作数：文件名

该命令用于指定 troff B 字体的文件名。  [1] 这是默认使用Times Bold打印的字体。

#### troff S font

```
      +---+------+----+
      | 4 | file | LF |
      +---+------+----+
```

指令码：4

操作数：文件名

该命令用于指定 troff S 字体的文件名。  [1] 这是默认使用Special Mathematical 打印的字体。

#### 绘制CIF文件

```
      +---+------+----+
      | c | file | LF |
      +---+------+----+
```

指令码：c

操作数：要绘制的文件

该命令将把数据作为 CIF（CalTech Intermediate Form）图形语言处理，从而绘制数据文件。[2]

#### 打印DVI文件

```
      +---+------+----+
      | d | file | LF |
      +---+------+----+
```

指令码：d

操作数：要打印的文件

该命令将打印数据文件，并将数据视为 DVI（TeX 输出）。[3]

#### 打印格式化文件

```
      +---+------+----+
      | f | file | LF |
      +---+------+----+
```

指令码：f

操作数：要打印的文件

 该命令将把数据文件打印为纯文本文件，并根据需要提供分页符。  任何不在以下列表中的 ASCII 控制字符都将被丢弃：HT、CR、FF、LF 和 BS。

#### 绘制文件

```
      +---+------+----+
      | g | file | LF |
      +---+------+----+
```

指令码：g

操作数：要绘制的文件

该命令会将数据文件绘制成曲线图，并将数据视为 Berkeley Unix 绘图库的输出结果。[1]

#### 保留k

保留给 Kerberized LPR 客户端和服务器使用。

#### 打印文件（包含控制字符）

```
      +---+------+----+
      | l | file | LF |
      +---+------+----+
```

指令码：l

操作数：要打印的文件

 该命令用于打印指定的数据文件，但不过滤控制字符（与 "f "命令相同）。

#### 打印 ditroff 输出文件

```
      +---+------+----+
      | n | file | LF |
      +---+------+----+
```

指令码：n

操作数：要打印的文件

该命令打印要打印的数据文件，将数据作为 ditroff 输出。

#### 打印 Postscript 输出文件

```
      +---+------+----+
      | o | file | LF |
      +---+------+----+
```

指令码：o

操作数：要打印的文件

该命令打印要打印的数据文件，并将数据视为标准 Postscript 输入。

#### 使用pr格式打印文件

```
      +---+------+----+
      | p | file | LF |
      +---+------+----+
```

指令码：p

操作数：要打印的文件

该命令将使数据文件打印出标题、页码和分页。  标题应包括开始打印的日期和时间、标题和页码标识符，页码后跟页码。  标题是 "N "命令指定的文件名，除非已给出 "T "命令（标题）。  打印完一页文本后，将以新的页码开始新的一页。  (无法指定页面长度）。

#### 使用 FORTRAN 回车控件打印的文件

```
      +---+------+----+
      | r | file | LF |
      +---+------+----+
```

指令码：r

操作数：要打印的文件

该命令用于要打印的数据文件，将每行的第一列作为FORTRAN回车空间。FORTRAN标准仅限于空格、“1”、“0”、“+”.

#### 打印 troff 输出文件

```
      +---+------+----+
      | t | file | LF |
      +---+------+----+
```

指令码：t

操作数：要打印的文件

该命令将数据文件打印为 Graphic Systems C/A/T 照排机输入。  [5] 这是 Unix "troff "命令的标准输出。

#### 打印raster文件

```
      +---+------+----+
      | v | file | LF |
      +---+------+----+
```

指令码：v

操作数：要打印的文件

This command prints a Sun raster format file

#### z-保留

给未来的Palladium print system保留

## 参考资料

+ [rfc-editor.org/rfc/rfc1179.txt](https://www.rfc-editor.org/rfc/rfc1179.txt)

